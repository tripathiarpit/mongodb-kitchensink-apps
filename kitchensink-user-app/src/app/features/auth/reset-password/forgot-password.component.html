<div class="signup-container">
  <div class="signup-background"></div>

  <div class="container py-4">
    <div class="row justify-content-center">
      <div class="col-12 col-lg-8 col-xl-6">
        <mat-card class="mat-elevation-z4">

          <!-- Header -->
          <mat-card-header class="signup-title text-center mb-4">
            <mat-card-title>
              <h2>Forgot Password</h2>
              <p class="text-muted">Reset your password in 3 easy steps</p>
            </mat-card-title>
          </mat-card-header>
          <ng-template #customSnack let-data>
            <div class="custom-snack-content">
              <mat-icon>check_circle</mat-icon>
              <span>{{ data.message }}</span>
            </div>
          </ng-template>
          <mat-card-content>
            <mat-horizontal-stepper [linear]="true" #stepper class="signup-stepper">

              <!-- Step 1: Email -->
              <mat-step [stepControl]="emailForm" label="Email">
                <form [formGroup]="emailForm" class="step-form">
                  <mat-form-field appearance="outline" class="mat-mdc-form-field w-100">
                    <mat-label>Email Address</mat-label>
                    <input matInput type="email" formControlName="email" placeholder="Enter your email">
                    <mat-icon matSuffix>email</mat-icon>
                    <mat-error *ngIf="emailForm.get('email')?.touched && emailForm.get('email')?.invalid">
                      Please enter a valid email address
                    </mat-error>
                  </mat-form-field>

                  <div class="step-actions">
                    <button mat-raised-button class="next-btn" (click)="sendOtp()"
                            [disabled]="emailForm.invalid || otpSending">
                      {{ otpSending ? 'Sending...' : 'Send OTP' }}
                    </button>
                    <button mat-raised-button class="next-btn" matStepperNext [disabled]="!otpSent">Next</button>
                  </div>
                </form>
              </mat-step>

              <!-- Step 2: OTP -->
              <mat-step [stepControl]="otpForm" label="Verify OTP" class="step-actions">
                <form [formGroup]="otpForm" class="step-form">
                  <mat-form-field appearance="outline" class="mat-mdc-form-field w-100">
                    <mat-label>Enter OTP</mat-label>
                    <input matInput maxlength="6" formControlName="otp" placeholder="6-digit code">
                    <mat-icon matSuffix>lock</mat-icon>
                    <mat-error *ngIf="otpForm.get('otp')?.touched && otpForm.get('otp')?.invalid">
                      OTP must be 6 digits
                    </mat-error>
                  </mat-form-field>

                  <div class="step-actions">
                    <button mat-raised-button (click)="startCountdown()" class="back-btn" matStepperPrevious>Back</button>
                    <button mat-raised-button  class="next-btn" (click)="verifyOtp()"
                            [disabled]="otpForm.invalid">
                      Verify
                    </button>

                      <button mat-raised-button class="next-btn"
                              (click)="reSendOtp()"
                              [disabled]="resendDisabled">
                        Resend OTP
                      </button>

                      <span *ngIf="resendDisabled" class="text-muted ml-2">
    (Wait {{ countdown }}s)
  </span>
                  </div>
                </form>
              </mat-step>

              <!-- Step 3: Reset Password -->
              <mat-step [stepControl]="passwordForm" label="New Password">
                <form [formGroup]="passwordForm" class="step-form">

                  <mat-form-field appearance="outline" class="mat-mdc-form-field w-100">
                    <mat-label>New Password</mat-label>
                    <input matInput [type]="hidePassword ? 'password' : 'text'"
                           formControlName="newPassword" placeholder="Enter new password">
                    <button mat-icon-button matSuffix type="button" (click)="hidePassword = !hidePassword">
                      <mat-icon>{{ hidePassword ? 'visibility_off' : 'visibility' }}</mat-icon>
                    </button>
                    <mat-error *ngIf="passwordForm.get('newPassword')?.touched && passwordForm.get('newPassword')?.invalid">
                      Password must be at least 6 characters
                    </mat-error>
                  </mat-form-field>

                  <mat-form-field appearance="outline" class="mat-mdc-form-field w-100">
                    <mat-label>Confirm Password</mat-label>
                    <input matInput [type]="hideConfirmPassword ? 'password' : 'text'"
                           formControlName="confirmPassword" placeholder="Confirm new password">
                    <button mat-icon-button matSuffix type="button" (click)="hideConfirmPassword = !hideConfirmPassword">
                      <mat-icon>{{ hideConfirmPassword ? 'visibility_off' : 'visibility' }}</mat-icon>
                    </button>
                    <mat-error *ngIf="(passwordForm.get('confirmPassword')?.invalid && passwordForm.get('confirmPassword')?.touched)
                      || passwordForm.hasError('passwordMismatch')
">
                      {{ getPersonalInfoErrorMessage('confirmPassword')}}
                    </mat-error>
                  </mat-form-field>

                  <div class="step-actions">

                    <button mat-raised-button class="submit-btn" (click)="resetPassword()"
                            [disabled]="passwordForm.invalid">
                      Reset Password
                    </button>
                  </div>
                </form>
              </mat-step>

            </mat-horizontal-stepper>

            @if (this.sharedState.showSignInLink$ |async) {
              <div class="text-center mt-4">
                <span class="text-muted">Remember your password? </span>
                <a class="signin-link" (click)="onBackToLogin()">Sign In</a>
              </div>
            }


          </mat-card-content>

        </mat-card>

      </div>
    </div>
  </div>
</div>
