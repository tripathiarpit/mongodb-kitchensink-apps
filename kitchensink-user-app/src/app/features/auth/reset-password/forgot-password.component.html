<div class="signup-container min-vh-100 d-flex flex-column justify-content-center align-items-center bg-light">
  <div class="signup-background position-absolute top-0 start-0 w-100 h-100"></div>

  <div class="container my-5 position-relative z-index-1">
    <div class="row justify-content-center">
      <div class="col-12 col-md-10 col-lg-8 col-xl-6">
        <mat-card class="mat-elevation-z8 rounded-lg shadow-lg p-4">

          <mat-card-header class="signup-title text-center mb-4 py-3 d-flex flex-column justify-content-center align-items-center">
            <mat-card-title class="d-flex flex-column justify-content-center align-items-center">
              <h2 class="h3 fw-bold text-primary mb-2">Forgot Password</h2>
              <p class="text-muted mb-0">Reset your password in 3 easy steps</p>
            </mat-card-title>
          </mat-card-header>

          <ng-template #customSnack let-data>
            <div class="custom-snack-content d-flex align-items-center p-2 rounded bg-success text-white">
              <mat-icon class="me-2">check_circle</mat-icon>
              <span>{{ data.message }}</span>
            </div>
          </ng-template>

          <mat-card-content class="p-4">
            <mat-horizontal-stepper [linear]="true" #stepper class="signup-stepper">

              <mat-step [stepControl]="emailForm" label="Email">
                <form [formGroup]="emailForm" class="step-form d-flex flex-column gap-3">
                  <mat-form-field appearance="outline" class="mat-mdc-form-field w-100">
                    <mat-label>Email Address</mat-label>
                    <input matInput type="email" formControlName="email" placeholder="Enter your email" class="form-control">
                    <mat-icon matSuffix>email</mat-icon>
                    <mat-error *ngIf="emailForm.get('email')?.touched && emailForm.get('email')?.invalid" class="text-danger">
                      {{getEmailErrorMessage('email')}}
                    </mat-error>
                  </mat-form-field>

                  <div class="step-actions d-flex justify-content-between align-items-center mt-4">
                    <button mat-raised-button class="next-btn btn btn-primary px-4 py-2 rounded-pill fw-bold" (click)="sendOtp()"
                            [disabled]="emailForm.invalid || otpSending">
                      {{ otpSending ? 'Sending...' : 'Send OTP' }}
                    </button>
                    <button mat-raised-button class="next-btn btn btn-outline-primary px-4 py-2 rounded-pill fw-bold" matStepperNext [disabled]="!otpSent">Next</button>
                  </div>
                </form>
              </mat-step>

              <mat-step [stepControl]="otpForm" label="Verify OTP">
                <form [formGroup]="otpForm" class="step-form d-flex flex-column gap-3">
                  <mat-form-field appearance="outline" class="mat-mdc-form-field w-100">
                    <mat-label>Enter OTP</mat-label>
                    <input matInput maxlength="6" formControlName="otp" placeholder="6-digit code" class="form-control text-center">
                    <mat-icon matSuffix>lock</mat-icon>
                    <mat-error *ngIf="otpForm.get('otp')?.touched && otpForm.get('otp')?.invalid" class="text-danger">
                      OTP must be 6 digits
                    </mat-error>
                  </mat-form-field>

                  <div class="step-actions d-flex flex-wrap justify-content-between align-items-center mt-4">
                    <button mat-raised-button (click)="startCountdown()" class="back-btn btn btn-outline-secondary px-3 py-2 rounded-pill fw-bold mb-2 mb-md-0" matStepperPrevious>Back</button>
                    <div class="d-flex align-items-center flex-wrap justify-content-end">
                      <button mat-raised-button class="next-btn btn btn-primary px-4 py-2 rounded-pill fw-bold me-2 mb-2 mb-md-0" (click)="verifyOtp()"
                              [disabled]="otpForm.invalid">
                        Verify
                      </button>

                      <button mat-raised-button class="next-btn btn btn-info px-3 py-2 rounded-pill fw-bold"
                              (click)="reSendOtp()"
                              [disabled]="resendDisabled">
                        Resend OTP
                      </button>

                      <span *ngIf="resendDisabled" class="text-muted ms-2">
                        (Wait {{ countdown }}s)
                      </span>
                    </div>
                  </div>
                </form>
              </mat-step>

              <mat-step [stepControl]="passwordForm" label="New Password">
                <form [formGroup]="passwordForm" class="step-form d-flex flex-column gap-3">
                  <mat-form-field appearance="outline" class="mat-mdc-form-field w-100">
                    <mat-label>New Password</mat-label>
                    <input matInput
                           [type]="hidePassword ? 'password' : 'text'"
                           formControlName="newPassword"
                           placeholder="Create a strong password" class="form-control">
                    <button mat-icon-button matSuffix type="button" (click)="hidePassword = !hidePassword" class="text-muted">
                      <mat-icon>{{ hidePassword ? 'visibility_off' : 'visibility' }}</mat-icon>
                    </button>
                    <mat-hint [matTooltip]="'Must not contain all spaces in password'" class="text-muted">Must contain uppercase, lowercase, number and special character</mat-hint>
                    <mat-error *ngIf="passwordForm.get('newPassword')?.invalid && passwordForm.get('newPassword')?.touched" class="text-danger">
                      {{getPersonalInfoErrorMessage('newPassword')}}
                    </mat-error>
                  </mat-form-field>

                  <mat-form-field appearance="outline" class="mat-mdc-form-field w-100">
                    <mat-label>Confirm Password</mat-label>
                    <input matInput [type]="hideConfirmPassword ? 'password' : 'text'"
                           formControlName="confirmPassword" placeholder="Confirm new password" class="form-control">
                    <button mat-icon-button matSuffix type="button" (click)="hideConfirmPassword = !hideConfirmPassword" class="text-muted">
                      <mat-icon>{{ hideConfirmPassword ? 'visibility_off' : 'visibility' }}</mat-icon>
                    </button>
                    <mat-error *ngIf="(passwordForm.get('confirmPassword')?.invalid && passwordForm.get('confirmPassword')?.touched)
                      || passwordForm.hasError('passwordMismatch')" class="text-danger">
                      {{ getPersonalInfoErrorMessage('confirmPassword')}}
                    </mat-error>
                  </mat-form-field>

                  <div class="step-actions d-flex justify-content-end mt-4">
                    <button mat-raised-button class="submit-btn btn btn-success px-5 py-2 rounded-pill fw-bold" (click)="resetPassword()"
                            [disabled]="passwordForm.invalid">
                      Reset Password
                    </button>
                  </div>
                </form>
              </mat-step>

            </mat-horizontal-stepper>

            @if (this.sharedState.showSignInLink$ |async) {
              <div class="text-center mt-4 pt-3 border-top">
                <span class="text-muted">Remember your password? </span>
                <a class="signin-link text-primary fw-bold text-decoration-none" (click)="onBackToLogin()">Sign In</a>
              </div>
            }
            @if (!(this.sharedState.showSignInLink$ |async)) {
              <div class="d-flex justify-content-center align-items-center mt-4 pt-3 border-top">
                <span class="text-muted me-2">Remember your password? </span>
                <button mat-raised-button (click)="onCancel()" class="next-btn btn btn-outline-secondary px-3 py-2 rounded-pill fw-bold">
                  Back
                </button>
              </div>
            }
          </mat-card-content>
        </mat-card>
      </div>
    </div>
  </div>
</div>
