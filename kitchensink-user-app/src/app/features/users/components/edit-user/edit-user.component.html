<div class="edit-user-container">
  <div class="card">
    <div class="card-header">
      <h3>Edit User</h3>
    </div>
    <div class="card-body">
      <form [formGroup]="userForm">
        <div class="section-title">
          <h5>User Information</h5>
        </div>

        <div class="row">
          <div class="col-md-6">
            <mat-form-field appearance="fill" class="w-100">
              <mat-label>Username</mat-label>
              <input matInput formControlName="username">
              @if(userForm.get('username')?.hasError('required') && userForm.get('username')?.touched) {
                <mat-error>Username is required</mat-error>
              }
              @if(userForm.get('username')?.hasError('minlength') && userForm.get('username')?.touched) {
                <mat-error>Minimum length is 3 characters</mat-error>
              }
            </mat-form-field>
          </div>
          <div class="col-md-6">
            <mat-form-field appearance="fill" class="w-100">
              <mat-label>Email</mat-label>
              <input matInput type="email" formControlName="email">
              @if(userForm.get('email')?.hasError('required') && userForm.get('email')?.touched) {
                <mat-error>Email is required</mat-error>
              }
              @if(userForm.get('email')?.hasError('email') && userForm.get('email')?.touched) {
                <mat-error>Invalid email format</mat-error>
              }
            </mat-form-field>
          </div>
        </div>

        <div class="row">
          <div class="col-md-6">
            <mat-form-field appearance="fill" class="w-100">
              <mat-label>Roles</mat-label>
              <mat-chip-grid #chipGrid formControlName="roles">
                <mat-chip-row
                  *ngFor="let role of userForm.value.roles"
                  (removed)="removeRole(role)"
                  [removable]="true">
                  {{ role }}
                  <button matChipRemove>
                    <mat-icon>cancel</mat-icon>
                  </button>
                </mat-chip-row>
                <input
                  placeholder="Add role..."
                  #roleInput
                  [matChipInputFor]="chipGrid"
                  [matChipInputSeparatorKeyCodes]="separatorKeysCodes"
                  (matChipInputTokenEnd)="addRole($event)" />
              </mat-chip-grid>
              @if(userForm.get('roles')?.hasError('required') && userForm.get('roles')?.touched) {
                <mat-error>At least one role is required</mat-error>
              }
              <mat-hint>Allowed roles: ADMIN and USER</mat-hint>
            </mat-form-field>
          </div>
          <div class="col-md-6">
            <mat-slide-toggle formControlName="active" class="mt-3">
              Active User
            </mat-slide-toggle>
            <mat-slide-toggle style="padding-left: 2rem" formControlName="twoFAEnabled" class="mt-lg-5">
              2FA Enabled
            </mat-slide-toggle>
          </div>
        </div>

        <div class="section-title mt-4">
          <h5>Profile Information</h5>
        </div>

        <div formGroupName="profile">
          <div class="row">
            <div class="col-md-6">
              <mat-form-field appearance="fill" class="w-100">
                <mat-label>First Name</mat-label>
                <input matInput formControlName="firstName">
                @if(userForm.get('profile.firstName')?.hasError('required') && userForm.get('profile.firstName')?.touched) {
                  <mat-error>First Name is required</mat-error>
                }
                @if(userForm.get('profile.firstName')?.hasError('minlength') && userForm.get('profile.firstName')?.touched) {
                  <mat-error>Minimum length is 2 characters</mat-error>
                }
              </mat-form-field>
            </div>
            <div class="col-md-6">
              <mat-form-field appearance="fill" class="w-100">
                <mat-label>Last Name</mat-label>
                <input matInput formControlName="lastName">
                @if(userForm.get('profile.lastName')?.hasError('required') && userForm.get('profile.lastName')?.touched) {
                  <mat-error>Last Name is required</mat-error>
                }
                @if(userForm.get('profile.lastName')?.hasError('minlength') && userForm.get('profile.lastName')?.touched) {
                  <mat-error>Minimum length is 2 characters</mat-error>
                }
              </mat-form-field>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6">
              <mat-form-field appearance="fill" class="w-100">
                <mat-label>Phone Number</mat-label>
                <input matInput type="tel" formControlName="phoneNumber">
                @if(userForm.get('profile.phoneNumber')?.hasError('required') && userForm.get('profile.phoneNumber')?.touched) {
                  <mat-error>Phone Number is required</mat-error>
                }
                @if(userForm.get('profile.phoneNumber')?.hasError('pattern') && userForm.get('profile.phoneNumber')?.touched) {
                  <mat-error>Invalid phone number format</mat-error>
                }
              </mat-form-field>
            </div>
            <div class="col-md-6">
              <mat-form-field appearance="fill" class="w-100">
                <mat-label>Street</mat-label>
                <input matInput formControlName="street">
                @if(userForm.get('profile.street')?.hasError('required') && userForm.get('profile.street')?.touched) {
                  <mat-error>Street is required</mat-error>
                }
              </mat-form-field>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6">
              <mat-form-field appearance="fill" class="w-100">
                <mat-label>City</mat-label>
                <input matInput formControlName="city">
                @if(userForm.get('profile.city')?.hasError('required') && userForm.get('profile.city')?.touched) {
                  <mat-error>City is required</mat-error>
                }
              </mat-form-field>
            </div>
            <div class="col-md-6">
              <mat-form-field appearance="fill" class="w-100">
                <mat-label>State</mat-label>
                <input matInput formControlName="state">
                @if(userForm.get('profile.state')?.hasError('required') && userForm.get('profile.state')?.touched) {
                  <mat-error>State is required</mat-error>
                }
              </mat-form-field>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6 mb-4">
              <mat-form-field appearance="outline" class="w-100">
                <mat-label>Country</mat-label>
                <mat-select
                  formControlName="country"
                  placeholder="Select country"
                  panelClass="country-dropdown-panel">

                  <mat-option class="select-search-option">
                    <input
                      matInput
                      type="text"
                      placeholder="Search country..."
                      [(ngModel)]="countryFilter"
                      [ngModelOptions]="{standalone: true}"
                      (click)="$event.stopPropagation()"
                      (keydown)="$event.stopPropagation()"
                      class="select-search-input" />
                  </mat-option>

                  <mat-option
                    *ngFor="let country of countries | countryFilter:countryFilter"
                    [value]="country"
                    class="select-country-option">
                    {{ country }}
                  </mat-option>

                </mat-select>
                <mat-icon matSuffix>public</mat-icon>
                @if(userForm.get('profile.country')?.hasError('required') && userForm.get('profile.country')?.touched) {
                  <mat-error>
                    Country is required
                  </mat-error>
                }
              </mat-form-field>
            </div>
            <div class="col-md-6">
              <mat-form-field appearance="fill" class="w-100">
                <mat-label>Pincode</mat-label>
                <input matInput formControlName="pincode">
                @if(userForm.get('profile.pincode')?.hasError('required') && userForm.get('profile.pincode')?.touched) {
                  <mat-error>Pincode is required</mat-error>
                }
              </mat-form-field>
            </div>
          </div>
        </div>

        <div class="section-title mt-4">
          <h5>System Information</h5>
        </div>

        <div class="row">
          <div class="col-md-6">
            <mat-form-field appearance="fill" class="w-100">
              <mat-label>User ID</mat-label>
              <input matInput formControlName="id" readonly>
            </mat-form-field>
          </div>
          <div class="col-md-6">
            <mat-form-field appearance="fill" class="w-100">
              <mat-label>Created At</mat-label>
              <input matInput formControlName="createdAt" readonly>
            </mat-form-field>
          </div>
        </div>

        <div class="action-buttons mt-4">
          <button mat-button type="button" (click)="cancel()" class="me-2">
            Cancel
          </button>
          <button mat-raised-button color="primary"
                  [disabled]="userForm.invalid"
                  (click)="save()">
            Save Changes
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
