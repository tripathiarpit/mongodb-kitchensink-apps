<div class="container mt-1" id="search-div" #searchDiv>
<mat-card class="mb-4">
  <mat-card-header>
  </mat-card-header>
  <mat-card-content>
    <div class="d-flex align-items-center gap-2 flex-wrap" >
      <mat-form-field appearance="outline" style="width: 150px;"  >
        <mat-label>Search by</mat-label>
        <mat-select [(value)]="searchBy" (selectionChange)="onSearchSelect()">
          <mat-option value="name">Name</mat-option>
          <mat-option value="email">Email</mat-option>
          <mat-option value="city">City</mat-option>
          <mat-option value="country">Country</mat-option>
          <mat-option value="all">No Criteria</mat-option>
        </mat-select>
      </mat-form-field>

      <!-- Conditional input -->
      <mat-form-field *ngIf="searchBy !== 'all'" appearance="outline" style="width: 250px;">
        <mat-label>Enter search text</mat-label>
        <input matInput [(ngModel)]="searchQuery" placeholder="Type here..." />
      </mat-form-field>

      <!-- Search button -->
      <button mat-raised-button color="primary" class="next-btn" (click)="onSearch()" >
        <mat-icon>search</mat-icon> Search
      </button>
    </div>
  </mat-card-content>
</mat-card>
<mat-card>
    <mat-card-header>
      <mat-card-title>Filter Results</mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <!-- Filter above table -->

      <div class="d-flex justify-content-between align-items-center mb-2 flex-wrap"  >
        <!-- Filter Input -->
        <mat-form-field appearance="outline" style="width: 250px;">
          <mat-label>Filter users</mat-label>
          <input matInput (keyup)="applyFilter($event)" placeholder="Filter by name, email, city, country">
        </mat-form-field>




        <div class="d-flex align-items-center gap-1" >
          <span >Sort by:</span>
          <mat-form-field appearance="outline" style="width: 180px;">
            <mat-select [(value)]="sortField" (selectionChange)="applySort()">
              <mat-option value="username">Username</mat-option>
              <mat-option value="name">Name</mat-option>
              <mat-option value="email">Email</mat-option>
              <mat-option value="city">City</mat-option>
              <mat-option value="country">Country</mat-option>
              <mat-option value="createdAt">Created At</mat-option>
            </mat-select>
          </mat-form-field>

          <!-- Sort Direction Icon -->
          <button mat-icon-button (click)="toggleSortDirection()" >
            <mat-icon>{{ sortDirection === 'asc' ? 'arrow_upward' : 'arrow_downward' }}</mat-icon>
          </button>
        </div>
        @if(this.selectedEmailsForDownload.length>0) {
          <button mat-raised-button color="primary" (click)="download()" style="height: 48px; font-size: 16px;">
            <mat-icon>download</mat-icon> Download Users CSV
          </button>
        }

      </div>
      <div class="table-container mat-elevation-z8" >
        <div class="table-scroll">
          <table mat-table [dataSource]="dataSource" matSort class="styled-mat-table">
            <!-- Columns -->
            <ng-container matColumnDef="count">
              <th mat-header-cell *matHeaderCellDef>#</th>
              <td mat-cell *matCellDef="let row; let i = index">
                {{ (paginator.pageIndex * paginator.pageSize) + i + 1 }}
              </td>
            </ng-container>

            <ng-container matColumnDef="username">
              <th mat-header-cell *matHeaderCellDef mat-sort-header> Username </th>
              <td mat-cell *matCellDef="let user"> {{ user.username || '-' }} </td>
            </ng-container>

            <ng-container matColumnDef="name">
              <th mat-header-cell *matHeaderCellDef> Name </th>
              <td mat-cell *matCellDef="let user">
                {{ user.profile?.firstName || '' }} {{ user.profile?.lastName || '' }}
              </td>
            </ng-container>

            <ng-container matColumnDef="email">
              <th mat-header-cell *matHeaderCellDef> Email </th>
              <td mat-cell *matCellDef="let user"> {{ user.email }} </td>
            </ng-container>
            <ng-container matColumnDef="city">
              <th mat-header-cell *matHeaderCellDef> City </th>
              <td mat-cell *matCellDef="let user"> {{ user.profile?.city || '-' }} </td>
            </ng-container>

            <ng-container matColumnDef="country">
              <th mat-header-cell *matHeaderCellDef> Country </th>
              <td mat-cell *matCellDef="let user"> {{ user.profile?.country || '-' }} </td>
            </ng-container>

            <ng-container matColumnDef="roles">
              <th mat-header-cell *matHeaderCellDef> Roles </th>
              <td mat-cell *matCellDef="let user">
                <span *ngFor="let role of user.roles" class="role-chip">{{ role }}</span>
              </td>
            </ng-container>

            <ng-container matColumnDef="createdAt">
              <th mat-header-cell *matHeaderCellDef mat-sort-header> Created At </th>
              <td mat-cell *matCellDef="let user">
                {{ user.createdAt | date: 'medium' }}
              </td>
            </ng-container>

            <ng-container matColumnDef="actions">
              <th mat-header-cell *matHeaderCellDef> Actions </th>
              <td mat-cell *matCellDef="let user" class="actions-cell">
                <button mat-icon-button color="primary" matTooltip="Edit User" (click)="editUser(user)">
                  <mat-icon>edit</mat-icon>
                </button>
                <button mat-icon-button color="warn" matTooltip="Delete User" (click)="deleteUser(user)">
                  <mat-icon>delete</mat-icon>
                </button>
                <button mat-icon-button color="accent" matTooltip="View Details" (click)="viewUserDetails(user)">
                  <mat-icon>visibility</mat-icon>
                </button>
              </td>
            </ng-container>

            <!-- Header & Rows -->
            <tr mat-header-row *matHeaderRowDef="displayedColumns" class="header-row"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns;" class="table-row-hover"></tr>
          </table>
        </div>

        <mat-paginator #paginator
                       [length]="totalRecords"
                       [pageSize]="pageSize"
                       [pageSizeOptions]="[5, 10, 20, 50]"
                       (page)="pageChange($event)"
                       showFirstLastButtons>
        </mat-paginator>
      </div>
    </mat-card-content>
</mat-card>
</div>
